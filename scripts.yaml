toggle_scene_from_input_select:
  alias: Toggle scene from input select
  variables:
    input_select_entity: 'input_select.bedroom_light_scene'
  sequence:
    - service: scene.turn_on
      data_template:
        entity_id: "{{ 'scene.bedroom_' + states(input_select_entity) | string | lower | regex_replace(find=' ', replace='_', ignorecase=False) }}"

let_light_blink:
  alias: Let ceiling light in kitchen blink
  mode: restart
  variables:
    blink_timeout: 1
    light_entity_id: 'light.kitchen_ceiling_light'
    observed_input_boolean: 'input_boolean.fride_door_was_left_open'
  sequence:
    repeat:
      while:
        - condition: template
          value_template: "{{ is_state(observed_input_boolean, 'on') }}"
      sequence:
        - service: light.turn_on
          data_template:
            entity_id: "{{ light_entity_id }}"
        - delay: "{{ blink_timeout }}"
        - service: light.turn_off
          data_template:
            entity_id: "{{ light_entity_id }}"
        - delay: "{{ blink_timeout }}"

toggle_light_scene:
  alias: Notify smart button pressed
  variables:
    light_group_id: ''
    scene_input_select_id: ''
  sequence:
    choose: 
      - conditions:
          condition: template
          value_template: "{{ is_state(light_group_id, 'on') }}"
        sequence:
          service: light.turn_off
          data_template:
            entity_id: "{{ light_group_id }}"
      - conditions:
          condition: template
          value_template: "{{ is_state(light_group_id, 'off') }}"
        sequence:
          - service: script.turn_on
            entity_id: script.toggle_scene_from_input_select
            data_template:
              variables:
                input_select_entity: "{{ scene_input_select_id }}"

notify_smart_button_pressed:
  alias: Notify smart button pressed
  variables:
    smart_button_id: ''
  sequence:
    - wait_template: "{{ is_state(smart_button_id, 'release') }}"
      timeout:
        milliseconds: 300
    - choose:
      - conditions:
        - condition: template
          value_template: "{{ not wait.completed }}"
        sequence:
          - wait_template: "{{ is_state(smart_button_id, 'hold') }}"
            timeout:
              milliseconds: 600
          - choose:
            - conditions:
              - condition: template
                value_template: "{{ not wait.completed }}"
              sequence:
                  - event: SMART_HOME_BUTTON_PRESS
                    event_data:
                      entity_id: "{{ smart_button_id }}"
            - conditions:
              - condition: template
                value_template: "{{ wait.completed }}"
              sequence:
                  - event: SMART_HOME_BUTTON_HOLD
                    event_data:
                      entity_id: "{{ smart_button_id }}"
      - conditions:
        - condition: template
          value_template: "{{ wait.completed }}"
        sequence:
          - event: SMART_HOME_BUTTON_RELEASE
            event_data:
              entity_id: "{{ smart_button_id }}"

create_light_scene_from_group:
  alias: Create Scene From Lights in Group
  variables:
    group_name: 'group.all_bedroom_lights'
    scene_name_input_text: 'input_text.bedroom_generated_scene_name'
    scene_prefix: 'Bedroom'
    timebased_scene_input_select: 'input_select.bedroom_time_based_scenes'
  sequence:
    - service: system_log.write
      data_template:
        message: 'Creating scene: {{ "scene." + scene_prefix | string | lower | replace(" ", "_") + "_" + states(scene_name_input_text) | lower | replace(" ", "_") }}'
        level: info
    - choose:
      - conditions:
        - condition: template
          value_template: >
            {{ states["scene." + scene_prefix | string | lower | replace(" ", "_") + "_" +  states(scene_name_input_text) | lower | replace(" ", "_")] == None }}
        - condition: template
          value_template: >
            {{ states[scene_name_input_text].state | string | length > 0}}
        sequence:
        - service: shell_command.truncate_file
          data_template:
            file_path: >
              'input/input_select/{{ scene_prefix | string | lower | replace(" ", "_") }}_generated.yaml'
        - service: shell_command.write_variable_content_to_file
          data_template:
            target_file: >
              'input/input_select/{{ scene_prefix | string | lower | replace(" ", "_") }}_generated.yaml'
            content: >
              {% set new_options = (states['input_select.' + scene_prefix | string | lower | replace(" ", "_") + '_light_scene_generated'].attributes.options | sort | join (",")) | string + "," + states(scene_name_input_text) %}
              {% set input_select_output %}
              {{ scene_prefix | string | lower | replace(" ", "_") }}_light_scene_generated:
                options:{% for option in (new_options.split(",") | sort) %}
                  - {{ option }}{% endfor %}
                initial: {{ states(scene_name_input_text) }}

              {{ scene_prefix | string | lower | replace(" ", "_") }}_automatic_light_scene_generated:
                options:{% for option in (new_options.split(",") | sort) %}
                  - {{ option }}{% endfor %}
                initial: {{ states(scene_name_input_text) }}

              {% for date_time_scene_tuple in states[timebased_scene_input_select].attributes.options %}{{ date_time_scene_tuple.split('/')[0].replace("_start_time", "") + "_choosen_scene"}}:
                options:{% for option in (new_options.split(",") | sort) %}
                  - {{ option }}{% endfor %}
                initial: {{ states(scene_name_input_text) }}

              {% endfor %}              
              {% endset %}
              {{ input_select_output }}
        - service: shell_command.write_variable_content_to_file
          data_template:
            target_file: >
              '{{ scene_prefix | string | lower | replace(" ", "_") }}/scenes.yaml'
            content: >
              {% set sceneoutput %}

              - name: {{ scene_prefix }} {{ states(scene_name_input_text) }}
                entities:{% for light in expand(group_name) %}
                  {{ light.entity_id }}:{% if light.attributes.brightness %}
                    brightness: {{ light.attributes.brightness }}{% endif %}{% if light.attributes.hs_color %}
                    hs_color:
                      - {{ light.attributes.hs_color[0] }}
                      - {{ light.attributes.hs_color[1] }}{% endif %}{% if light.attributes.rgb_color %}
                    rgb_color:
                      - {{ light.attributes.rgb_color[0] }}
                      - {{ light.attributes.rgb_color[1] }}
                      - {{ light.attributes.rgb_color[2] }}{% endif %}{% if light.attributes.xy_color %}
                    xy_color:
                      - {{ light.attributes.xy_color[0] }}
                      - {{ light.attributes.xy_color[1] }}{% endif %}{% if light.attributes.color_temp %}
                    color_temp: {{ light.attributes.color_temp }}{% endif %}
                    state: \"{{ light.state }}\"{% endfor %}
              {% endset %}
              {{ sceneoutput }}
        - service: scene.reload
        - service: input_select.reload
        - service: persistent_notification.create
          data:
            message: "Scene '{{ states(scene_name_input_text) }}'' successfully created"
            title: "Scene created for {{ scene_prefix }}"
        - service: input_text.set_value
          data_template:
            entity_id: "{{ scene_name_input_text }}"
            value: ''
      default:
        - service: persistent_notification.create
          data:
            message: "Either scene already exists or no scene name was given!"
            title: "Scene creation failed"        